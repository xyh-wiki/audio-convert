# Nixpacks configuration for audio-convert
# This file instructs Nixpacks how to build and run the application.

[env]
NODE_ENV = "production"

[setup]
# Ensure a modern node version is available (Nix package name for nodejs)
# Using nodejs_20 instead of nodejs-20_x for Vite 7.2.7 compatibility (requires ^20.19.0 || >=22.12.0)
packages = ["nodejs_20"]

[phases.build]
commands = [
  "npm ci || npm install",
  "npm run build",
  "node scripts/copy-ffmpeg-assets.js || true"
]

[phases.start]
# Use Caddy to serve dist with proper headers for FFmpeg
# Note: Nixpacks copies config to /assets/ during build, not /app/
command = "caddy run --config /assets/Caddyfile --adapter caddyfile"

[expose]
port = 3000
